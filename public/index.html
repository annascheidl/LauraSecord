<!DOCTYPE html>
<html>
    <head>
      <title>Laura Secord - Homepage</title>
      <meta name="description" content="Hello, WebVR! - A-Frame">

      <script src="/js/aframe.min.js"></script>
      <script src="/js/aframe-environment-component.min.js"></script>
      <script src="/js/aframe-particle-system-component.min.js"></script>
      <script src="/js/aframe-physics-system.min.js"></script>

      <link rel="stylesheet" href="/css/user-gesture.css">

      <!--script src="/js/aframe-map.min.js"></script>
      <--script src="index.js"></script-->
      <script>
        function convertCords(oldVector){
          return oldVector.x +' ' + oldVector.z +' '+ -oldVector.y;
        }

        function SpawnObject(value){
          var newObj;
          switch(value){
            case 0:
              //box
              newObj = document.createElement('a-box');
              break;
            case 1:
              //sphere
              newObj = document.createElement('a-sphere');
              break;
            case 2:
              //cylinder
              newObj = document.createElement('a-cylinder');
              break;
            case 3:
              //torus
              newObj = document.createElement('a-torus');
              break;
            default:
              //empty space
              newObj = 'null'
              break;
          }
          return newObj
        }

        function getHeightData(img,scale) {
     
          if (scale == undefined) scale=1;
          
              var canvas = document.createElement( 'canvas' );
              canvas.width = img.width;
              canvas.height = img.height;
              var context = canvas.getContext( '2d' );
      
              var size = img.width * img.height;
              var data = new Float32Array( size );
      
              context.drawImage(img,0,0);
      
              for ( var i = 0; i < size; i ++ ) {
                  data[i] = 0
              }
      
              var imgd = context.getImageData(0, 0, img.width, img.height);
              var pix = imgd.data;
      
              var j=0;
              for (var i = 0; i<pix.length; i +=4) {
                  var all = pix[i]+pix[i+1]+pix[i+2];
                  data[j++] = all/(12*scale);
              }
              
              return data;
      }
        AFRAME.registerComponent('start-experience', {
            init: function () {
            //we can't play sound on some browsers until we have some user interaction
            //this means we should only start playing ambient music after this button is clicked
            
            
            
            console.log('scene loaded');
            document.querySelector('#loading-animation').style.display='none';
            document.querySelector('#user-gesture-button').style.display='block';

            document.querySelector('#height-map');

            
            }
        });
        AFRAME.registerComponent('ground-plane', {
          init: function () {
            //get height data from img
            var img = new Image();
            img.src='assets/Heightmap_100.jpg';
            var data = getHeightData(img);

            var envObj;
            //console.log('confirm');
            // plane
            var geometry = new THREE.PlaneGeometry(100,100,99,99);
            var material = new THREE.MeshStandardMaterial({
              color: 0xE50096,
              roughness: 0.1,
              metalness:0.5,
              flatShading: true
              //wireframe: true
            });
            plane = new THREE.Mesh( geometry, material );

            //var minTest = 50;
            //set height of vertices
            for ( var i = 0; i<plane.geometry.vertices.length; i++ ) {
              plane.geometry.vertices[i].z = (data[i]*0.3);
              plane.geometry.vertices[i].y*=10;
              plane.geometry.vertices[i].x*=10;

              envObj = SpawnObject(parseInt(Math.random()*70));
              if(envObj=='null'){
                console.log('skip');
              }
              else{
                envObj.setAttribute('position', convertCords(plane.geometry.vertices[i]));
                document.querySelector('a-scene').appendChild(envObj);
                envObj.addEventListener('loaded', function () {
                  console.log('envObj attached');
                });
              }
            }
            var testBox1 = document.querySelector('#testBox1');
            var testBox2 = document.querySelector('#testBox2');
            var testBox3 = document.querySelector('#testBox3');
            //var testObj = document.querySelector('#testObj');



            this.el.setObject3D('mesh', plane);
            this.el.setAttribute('static-body');
            testBox1.setAttribute('position', convertCords(plane.geometry.vertices[500]));
            //testObj.setAttribute('position', convertCords(plane.geometry.vertices[505]));
            testBox2.setAttribute('position', convertCords(plane.geometry.vertices[5000]));
            testBox3.setAttribute('position', convertCords(plane.geometry.vertices[8000]));
            
            //console.log(plane.geometry.vertices[500].x +' '+ plane.geometry.vertices[500].z  +' '+ plane.geometry.vertices[500].y);
            //console.log(testBox1.getAttribute('position'));
          },
        update: function () {
            //var planeEntity = document.querySelector('a-plane');
            //console.log(this.el.getObject3D('mesh').geometry.vertices[0]);
          }
        });
        //function called from user-gesture click
        const startExperience = function() {
            //hide user-gesture overlay
            document.querySelector('#user-gesture-overlay').style.display='none';
                    
            //start all ambient music
            const ambientSounds = document.querySelectorAll('.ambient-music');
            ambientSounds.forEach(function(soundEntity) {
            soundEntity.components.sound.playSound();
            });
        }
      </script>
    </head>
    <body>
      <div id="user-gesture-overlay">
        <div class="center">
            <button id="user-gesture-button" onclick="startExperience();">enter experience</button>
            <!-- loading gif from: https://www.behance.net/gallery/31234507/Open-source-Loading-GIF-Icons-Vol-1 -->
            <img id="loading-animation" src="/assets/loader_animation.gif">
        </div>
    </div>
      <a-scene start-experience>
        
        <a-assets physics="debug: true" timeout="10000">
          
          <img id="height-map" src="assets/Heightmap_100.jpg">
          
          <audio id="background_music" src="/assets/bensound-sweet.mp3" preload="auto" crossorigin="anonymous"></audio>

          <a-asset-item id="rock-model-one-obj"  response-type="arraybuffer" src="/assets/designRock_1.obj" crossorigin="anonymous"></a-asset-item>
          <!--a-asset-item id="rock_model_one_mtl"     response-type="arraybuffer" src="/assets/designRock_1.mtl"></a-asset-item-->
          
          <a-asset-item id="rock_model_two_obj" response-type="arraybuffer" src="/assets/designRock_2.obj" crossorigin="anonymous"></a-asset-item>
          <!--a-asset-item id="rock_model_two_mtl"     response-type="arraybuffer" src="/assets/designRock_2.mtl"></a-asset-item-->

        
        </a-assets>

        <a-entity camera wasd-controls look-controls position="0 20.6 0">
          <a-entity cursor="rayOrigin:mouse;" raycaster="far:20; interval:200; objects:.interactive"></a-entity>
          <a-entity light="type:spot; intensity:1.4; castShadow:true; shadowBias:-0.0005; angle:40; penumbra:0.3;" position="0.5 -0.5 0" rotation="0 0 0"></a-entity>
        </a-entity>        
        
        <a-entity class="ambient-music" sound="src:#background_music; autoplay:false;"></a-entity>

        <!--a-entity light="type: ambient; color: #CCC"></a-entity-->
        <a-entity light="type: directional; color: #EEE; intensity: 0.5" position="-1 1 0"></a-entity>

        <a-plane ground-plane id="testBed" rotation="-90 0 0" static-body color="#7BC8A4" width="1" height="1" depth="1"></a-plane>
        
        <a-box id='testBox1' position="2 0.6 2" color="#4CC3D9" static-body></a-box>
        <a-box id='testBox2' position="-2 0.6 -2" color="#4CC3D9" static-body></a-box>
        <a-box id='testBox3' position="2 5.6 0" color="#4CC3D9" static-body></a-box>

        <!--a-entity id="testObj" position="-500 25.6 -450"  src="#rock-model-one-obj"></a-entity>

        <a-entity id="testObj2" position="-500 25.6 -450" rotation="0 0 0" scale="10 10 10"  obj-model="obj: #rock_model_two_obj"></a-entity>
        <a-entity ground-plane material="color: red" geometry="primitive: plane" position="0 0 0" rotation="-90 0 0" width="400" height="400"  static-body></a-entity>

        <a-entity  static-body environment="preset:dream; ground:hills;"></a-entity-->
      </a-scene>

      
    </body>
</html>