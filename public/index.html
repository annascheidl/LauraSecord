<!DOCTYPE html>
<html>
    <head>
      <title>Laura Secord - Homepage</title>
      <meta name="description" content="Hello, WebVR! - A-Frame">

      <script src="/js/aframe.min.js"></script>
      <script src="/js/aframe-environment-component.min.js"></script>
      <script src="/js/aframe-particle-system-component.min.js"></script>
      <script src="/js/aframe-physics-system.min.js"></script>

      <link rel="stylesheet" href="/css/user-gesture.css">

      <!--script src="/js/aframe-map.min.js"></script>
      <--script src="index.js"></script-->
      <script>
        function getHeightData(img,scale) {
     
          if (scale == undefined) scale=1;
          
              var canvas = document.createElement( 'canvas' );
              canvas.width = img.width;
              canvas.height = img.height;
              var context = canvas.getContext( '2d' );
      
              var size = img.width * img.height;
              var data = new Float32Array( size );
      
              context.drawImage(img,0,0);
      
              for ( var i = 0; i < size; i ++ ) {
                  data[i] = 0
              }
      
              var imgd = context.getImageData(0, 0, img.width, img.height);
              var pix = imgd.data;
      
              var j=0;
              for (var i = 0; i<pix.length; i +=4) {
                  var all = pix[i]+pix[i+1]+pix[i+2];
                  data[j++] = all/(12*scale);
              }
              
              return data;
      }
        AFRAME.registerComponent('start-experience', {
            init: function () {
            //we can't play sound on some browsers until we have some user interaction
            //this means we should only start playing ambient music after this button is clicked
            
            
            
            console.log('scene loaded');
            document.querySelector('#loading-animation').style.display='none';
            document.querySelector('#user-gesture-button').style.display='block';

            document.querySelector('#height-map');

            
            }
        });
        AFRAME.registerComponent('ground-plane', {
          init: function () {
            //get height data from img
            var img = new Image();
            img.src='assets/Heightmap_1000_test.jpg';
            var data = getHeightData(img);

            console.log('confirm');
            // plane
            var geometry = new THREE.PlaneGeometry(1000,1000,999,999);
            var material = new THREE.MeshBasicMaterial({
              color: 0xff0000,
              wireframe: true
            });
            plane = new THREE.Mesh( geometry, material );

            var min = 50;
            //set height of vertices
            for ( var i = 0; i<plane.geometry.vertices.length; i++ ) {
                plane.geometry.vertices[i].z = data[i] - 21;
            }
            

            this.el.setObject3D('mesh', plane);
            this.el.setAttribute('static-body');
          },
        update: function () {
            var planeEntity = document.querySelector('a-plane');
            //console.log(planeEntity.geometry.vertices[500+500]);
          }
        });
        //function called from user-gesture click
        const startExperience = function() {
            //hide user-gesture overlay
            document.querySelector('#user-gesture-overlay').style.display='none';
                    
            //start all ambient music
            const ambientSounds = document.querySelectorAll('.ambient-music');
            ambientSounds.forEach(function(soundEntity) {
            soundEntity.components.sound.playSound();
            });
        }
      </script>
    </head>
    <body>
      <div id="user-gesture-overlay">
        <div class="center">
            <button id="user-gesture-button" onclick="startExperience();">enter experience</button>
            <!-- loading gif from: https://www.behance.net/gallery/31234507/Open-source-Loading-GIF-Icons-Vol-1 -->
            <img id="loading-animation" src="/assets/loader_animation.gif">
        </div>
    </div>
      <a-scene start-experience>
        
        <a-assets physics="debug: true" timeout="10000">
          
          <img id="height-map" src="assets/Heightmap_1000_test.jpg">
          
          <audio id="background_music" src="/assets/bensound-sweet.mp3" preload="auto" crossorigin="anonymous"></audio>
        
        </a-assets>

        <a-entity camera wasd-controls look-controls position="0 20 0">
          <a-entity cursor="rayOrigin:mouse;" raycaster="far:20; interval:200; objects:.interactive"></a-entity>
          <a-entity light="type:spot; intensity:1.4; castShadow:true; shadowBias:-0.0005; angle:40; penumbra:0.3;" position="0.5 -0.5 0" rotation="0 0 0"></a-entity>
        </a-entity>        
       
        <a-entity class="ambient-music" sound="src:#background_music; autoplay:false;"></a-entity>

        <a-plane ground-plane id="testBed" rotation="-90 0 0" static-body color="#7BC8A4" width="100" height="100" depth="100"></a-plane>
        <a-box position="5 5 -5" color="#4CC3D9" dynamic-body></a-box>
        <a-box position="-5 5 5" color="#4CC3D9" dynamic-body></a-box>
        <a-box position="0 5 -5" color="#4CC3D9" dynamic-body></a-box>
        <a-box position="0 5 5" color="#4CC3D9" dynamic-body></a-box>
        <a-entity  material="color: red" geometry="primitive: plane" position="0 0 0" rotation="-90 0 0" width="4" height="4"  static-body></a-entity>

        <!--a-entity  static-body environment="preset:dream; ground:hills;"></a-entity-->
      </a-scene>

      
    </body>
</html>